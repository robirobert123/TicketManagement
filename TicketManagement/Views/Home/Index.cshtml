@model TicketManagement.Models.DashboardModel
@using Microsoft.AspNetCore.Identity
@using TicketManagement.Areas.Identity.Data
@inject SignInManager<TicketManagementUser> SignInManager
@inject UserManager<TicketManagementUser> UserManager

@{
    ViewBag.Title = "Ticket Dashboard";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="dashboard-wrapper">
    <div class="search-bar-wrapper">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search tickets...">
            <button id="search-button" class="btn-search">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <div class="filter-dropdown">
            <span>Filter by:</span>
            <select id="filter-priority" class="filter-select">
                <option value="all">All Priorities</option>
                @foreach (var priority in Model.TicketPriorities)
                {
                    <option value="@priority.Value">@priority.Text</option>
                }
            </select>
        </div>
    </div>

    <!-- Status Cards Row -->
    <div class="status-cards">
        <div class="status-card todo">
            <div class="status-icon">
                <i class="bi bi-list-check"></i>
            </div>
            <div class="status-name">To Do</div>
            <div class="status-count">@Model.TicketDetails.Count(t => t.StatusText == "To Do" || t.StatusText == "Open")</div>
        </div>
        <div class="status-card in-progress">
            <div class="status-icon">
                <i class="bi bi-arrow-repeat"></i>
            </div>
            <div class="status-name">In Progress</div>
            <div class="status-count">@Model.TicketDetails.Count(t => t.StatusText == "In Progress")</div>
        </div>
        <div class="status-card testing">
            <div class="status-icon">
                <i class="bi bi-check2-circle"></i>
            </div>
            <div class="status-name">Testing</div>
            <div class="status-count">@Model.TicketDetails.Count(t => t.StatusText == "Testing")</div>
        </div>
        <div class="status-card done">
            <div class="status-icon">
                <i class="bi bi-check2-all"></i>
            </div>
            <div class="status-name">Done</div>
            <div class="status-count">@Model.TicketDetails.Count(t => t.StatusText == "Closed" || t.StatusText == "Done")</div>
        </div>
    </div>

    <!-- Ticket Board -->
    <div class="board-container">
        <!-- To Do Column -->
        <div class="board-column">
            <div class="column-header">
                <h2>To Do</h2>
                <span class="ticket-count">@Model.TicketDetails.Count(t => t.StatusText == "To Do" || t.StatusText == "Open")</span>
            </div>
            <div class="column-content">
                @foreach (var ticket in Model.TicketDetails.Where(t => t.StatusText == "To Do" || t.StatusText == "Open"))
                {
                    <div class="ticket-card" data-id="@ticket.TicketID" data-status-id="@ticket.StatusID">
                        <div class="ticket-header">
                            <h3 class="ticket-title">@ticket.Title</h3>
                            <span class="ticket-id">#@ticket.TicketID</span>
                        </div>
                        <div class="ticket-meta">
                            <div class="ticket-priority @ticket.PriorityText.ToLower()">
                                <span>@ticket.PriorityText</span>
                            </div>
                            <div class="ticket-category">
                                <span>@ticket.CategoryText</span>
                            </div>
                        </div>
                        <div class="ticket-assignee">
                            <div class="avatar">
                                @if (!string.IsNullOrEmpty(ticket.AssigneeName))
                                {
                                    @ticket.AssigneeName.Substring(0, 1)
                                }
                                else
                                {
                                    <i class="bi bi-person"></i>
                                }
                            </div>
                            <span>@(string.IsNullOrEmpty(ticket.AssigneeName) ? "Unassigned" : ticket.AssigneeName)</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="board-column">
            <div class="column-header">
                <h2>In Progress</h2>
                <span class="ticket-count">@Model.TicketDetails.Count(t => t.StatusText == "In Progress")</span>
            </div>
            <div class="column-content">
                @foreach (var ticket in Model.TicketDetails.Where(t => t.StatusText == "In Progress"))
                {
                    <div class="ticket-card" data-id="@ticket.TicketID" data-status-id="@ticket.StatusID">
                        <div class="ticket-header">
                            <h3 class="ticket-title">@ticket.Title</h3>
                            <span class="ticket-id">#@ticket.TicketID</span>
                        </div>
                        <div class="ticket-meta">
                            <div class="ticket-priority @ticket.PriorityText.ToLower()">
                                <span>@ticket.PriorityText</span>
                            </div>
                            <div class="ticket-category">
                                <span>@ticket.CategoryText</span>
                            </div>
                        </div>
                        <div class="ticket-assignee">
                            <div class="avatar">
                                @if (!string.IsNullOrEmpty(ticket.AssigneeName))
                                {
                                    @ticket.AssigneeName.Substring(0, 1)
                                }
                                else
                                {
                                    <i class="bi bi-person"></i>
                                }
                            </div>
                            <span>@(string.IsNullOrEmpty(ticket.AssigneeName) ? "Unassigned" : ticket.AssigneeName)</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Testing Column -->
        <div class="board-column">
            <div class="column-header">
                <h2>Testing</h2>
                <span class="ticket-count">@Model.TicketDetails.Count(t => t.StatusText == "Testing")</span>
            </div>
            <div class="column-content">
                @foreach (var ticket in Model.TicketDetails.Where(t => t.StatusText == "Testing"))
                {
                    <div class="ticket-card" data-id="@ticket.TicketID" data-status-id="@ticket.StatusID">
                        <div class="ticket-header">
                            <h3 class="ticket-title">@ticket.Title</h3>
                            <span class="ticket-id">#@ticket.TicketID</span>
                        </div>
                        <div class="ticket-meta">
                            <div class="ticket-priority @ticket.PriorityText.ToLower()">
                                <span>@ticket.PriorityText</span>
                            </div>
                            <div class="ticket-category">
                                <span>@ticket.CategoryText</span>
                            </div>
                        </div>
                        <div class="ticket-assignee">
                            <div class="avatar">
                                @if (!string.IsNullOrEmpty(ticket.AssigneeName))
                                {
                                    @ticket.AssigneeName.Substring(0, 1)
                                }
                                else
                                {
                                    <i class="bi bi-person"></i>
                                }
                            </div>
                            <span>@(string.IsNullOrEmpty(ticket.AssigneeName) ? "Unassigned" : ticket.AssigneeName)</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Done Column -->
        <div class="board-column">
            <div class="column-header">
                <h2>Done</h2>
                <span class="ticket-count">@Model.TicketDetails.Count(t => t.StatusText == "Closed" || t.StatusText == "Done")</span>
            </div>
            <div class="column-content">
                @foreach (var ticket in Model.TicketDetails.Where(t => t.StatusText == "Closed" || t.StatusText == "Done"))
                {
                    <div class="ticket-card" data-id="@ticket.TicketID" data-status-id="@ticket.StatusID">
                        <div class="ticket-header">
                            <h3 class="ticket-title">@ticket.Title</h3>
                            <span class="ticket-id">#@ticket.TicketID</span>
                        </div>
                        <div class="ticket-meta">
                            <div class="ticket-priority @ticket.PriorityText.ToLower()">
                                <span>@ticket.PriorityText</span>
                            </div>
                            <div class="ticket-category">
                                <span>@ticket.CategoryText</span>
                            </div>
                        </div>
                        <div class="ticket-assignee">
                            <div class="avatar">
                                @if (!string.IsNullOrEmpty(ticket.AssigneeName))
                                {
                                    @ticket.AssigneeName.Substring(0, 1)
                                }
                                else
                                {
                                    <i class="bi bi-person"></i>
                                }
                            </div>
                            <span>@(string.IsNullOrEmpty(ticket.AssigneeName) ? "Unassigned" : ticket.AssigneeName)</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <a href="@Url.Action("Create", "Ticket")" class="btn-create-ticket">
        <i class="bi bi-plus"></i>
    </a>
</div>



@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script>
        $(document).ready(function() {
            // Funcția de căutare
            function performSearch() {
                const searchTerm = $("#search-input").val().toLowerCase();
                
                if (searchTerm === '') {
                    $(".ticket-card").show();
                    return;
                }
                
                $(".ticket-card").each(function() {
                    const title = $(this).find(".ticket-title").text().toLowerCase();
                    
                    if (title.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }
            
            // Click pe butonul de căutare
            $("#search-button").click(function() {
                performSearch();
            });
            
            // Căutare la apăsarea tastei Enter
            $("#search-input").keypress(function(e) {
                if (e.which === 13) { // Codul tastei Enter
                    e.preventDefault();
                    performSearch();
                }
            });
            
            // Aplică filtrul în funcție de prioritatea selectată
            function applyPriorityFilter() {
                const selectedPriority = $("#filter-priority").val();
                
                if (selectedPriority === 'all') {
                    // Arată toate coloanele și tichetele
                    $(".board-column").show();
                    $(".ticket-card").show();
                } else {
                    // Arată mai întâi toate coloanele
                    $(".board-column").show();
                    
                    // Ascunde tichetele care nu corespund priorității selectate
                    $(".ticket-card").each(function() {
                        const ticketPriorityClass = $(this).find(".ticket-priority").attr("class");
                        // Extrage valoarea priorității din clasă (ex: "ticket-priority high" -> "high")
                        const priorityValue = ticketPriorityClass.split(" ")[1];
                        
                        // Verifică dacă textul priorității corespunde ID-ului priorității selectate
                        // Aceasta necesită maparea textului priorității la ID
                        if (getPriorityIdFromClass(priorityValue) == selectedPriority) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
                }
                
                // Actualizează întotdeauna contoarele după aplicarea filtrului
                updateCounters();
            }

            // Funcție ajutătoare pentru a mapa clasa priorității la ID-ul priorității
            function getPriorityIdFromClass(priorityClass) {
                switch(priorityClass) {
                    case 'low':
                        return 3; // ID pentru prioritatea "Low"
                    case 'medium':
                        return 2; // ID pentru prioritatea "Medium"
                    case 'high':
                        return 1; // ID pentru prioritatea "High"
                    default:
                        return null;
                }
            }

            // Evenimentul de filtrare în funcție de prioritate
            $("#filter-priority").change(function() {
                applyPriorityFilter();
            });
            
            // Click pe tichet
            $(".ticket-card").click(function() {
                const ticketId = $(this).data("id");
                window.location.href = '@Url.Action("Details", "Ticket")/' + ticketId;
            });
            
            // Inițializare drag and drop pentru fiecare coloană
            const columns = document.querySelectorAll('.column-content');
            
            columns.forEach((column, index) => {
                new Sortable(column, {
                    group: 'tickets',
                    animation: 150,
                    ghostClass: 'ticket-card-ghost',
                    chosenClass: 'ticket-card-chosen',
                    dragClass: 'ticket-card-drag',
                    onEnd: function(evt) {
                        const ticketId = evt.item.getAttribute('data-id');
                        const newStatus = getStatusFromColumnIndex(evt.to.parentElement.querySelector('.column-header h2').textContent.trim());
                        
                        if (ticketId && newStatus) {
                            updateTicketStatus(ticketId, newStatus);
                            
                            // Actualizează status id-ul
                            $(evt.item).attr('data-status-id', newStatus);
                        }
                    }
                });
            });
            
            // Obține ID-ul statusului din numele coloanei
            function getStatusFromColumnIndex(columnName) {
                switch(columnName) {
                    case 'To Do':
                        return 1004; // ID pentru statusul "To Do"
                    case 'In Progress':
                        return 1005; // ID pentru statusul "In Progress"
                    case 'Testing':
                        return 1008; // ID pentru statusul "Testing"
                    case 'Done':
                        return 1006; // ID pentru statusul "Done/Closed"
                    default:
                        return null;
                }
            }
            
            // Actualizează statusul tichetului cu AJAX
            function updateTicketStatus(ticketId, statusId) {
                $('.ticket-card').off('click').on('click', function(e) {
                    const ticketId = $(this).data("id");
                    window.location.href = '@Url.Action("Details", "Ticket")/' + ticketId;
                });
                
                $.ajax({
                    url: '@Url.Action("UpdateStatus", "Ticket")',
                    type: 'POST',
                    data: {
                        ticketId: ticketId,
                        statusId: statusId
                    },
                    success: function(response) {
                        if (response.success) {
                            // Actualizarea a fost realizată cu succes
                            updateCounters();
                        } else {
                            // Gestionează eroarea
                            alert('Eroare la actualizarea statusului tichetului: ' + response.message);
                            // Reîmprospătează pagina pentru a reseta tabla
                            location.reload();
                        }
                    },
                    error: function() {
                        alert('Eroare la actualizarea statusului tichetului. Vă rugăm să încercați din nou.');
                        // Reîmprospătează pagina pentru a reseta tabla
                        location.reload();
                    }
                });
            }
            
            // Actualizează contoarele după drag and drop
            function updateCounters() {
                // Numără toate tichetele din fiecare coloană (nu doar cele vizibile)
                const todoCount = $('.board-column:nth-child(1) .column-content .ticket-card').length;
                const inProgressCount = $('.board-column:nth-child(2) .column-content .ticket-card').length;
                const testingCount = $('.board-column:nth-child(3) .column-content .ticket-card').length;
                const doneCount = $('.board-column:nth-child(4) .column-content .ticket-card').length;
                
                // Actualizează cardurile de status cu numărul total (indiferent de filtru)
                $('.status-card.todo .status-count').text(todoCount);
                $('.status-card.in-progress .status-count').text(inProgressCount);
                $('.status-card.testing .status-count').text(testingCount);
                $('.status-card.done .status-count').text(doneCount);
                
                // Actualizează anteturile coloanelor cu numărul total (indiferent de filtru)
                $('.board-column:nth-child(1) .ticket-count').text(todoCount);
                $('.board-column:nth-child(2) .ticket-count').text(inProgressCount);
                $('.board-column:nth-child(3) .ticket-count').text(testingCount);
                $('.board-column:nth-child(4) .ticket-count').text(doneCount);
            }
            
            // Actualizare inițială a contoarelor la încărcarea paginii
            updateCounters();
        });
    </script>
}

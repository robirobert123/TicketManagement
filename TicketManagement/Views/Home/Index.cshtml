@model TicketManagement.Models.DashboardModel

@{
    ViewBag.Title = "Ticket Dashboard";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="dashboard-wrapper">
    <div class="search-bar-wrapper">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search tickets...">
            <button id="search-button" class="btn-search">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <div class="filter-dropdown">
            <span>Filter by:</span>
            <select id="filter-status" class="filter-select">
                <option value="all">All Statuses</option>
                @foreach (var status in Model.Statuses)
                {
                    <option value="@status.StatusID">@status.StatusName</option>
                }
            </select>
        </div>
    </div>

    <!-- Status Cards Row -->
    <div class="status-cards">
        <div class="status-card todo">
            <div class="status-icon">
                <i class="bi bi-list-check"></i>
            </div>
            <div class="status-name">To Do</div>
            <div class="status-count">@Model.TicketDetails.Count(t => t.StatusText == "To Do" || t.StatusText == "Open")</div>
        </div>
        <div class="status-card in-progress">
            <div class="status-icon">
                <i class="bi bi-arrow-repeat"></i>
            </div>
            <div class="status-name">In Progress</div>
            <div class="status-count">@Model.TicketDetails.Count(t => t.StatusText == "In Progress")</div>
        </div>
        <div class="status-card testing">
            <div class="status-icon">
                <i class="bi bi-check2-circle"></i>
            </div>
            <div class="status-name">Testing</div>
            <div class="status-count">@Model.TicketDetails.Count(t => t.StatusText == "Testing")</div>
        </div>
        <div class="status-card done">
            <div class="status-icon">
                <i class="bi bi-check2-all"></i>
            </div>
            <div class="status-name">Done</div>
            <div class="status-count">@Model.TicketDetails.Count(t => t.StatusText == "Closed" || t.StatusText == "Done")</div>
        </div>
    </div>

    <!-- Ticket Board -->
    <div class="board-container">
        <!-- To Do Column -->
        <div class="board-column">
            <div class="column-header">
                <h2>To Do</h2>
                <span class="ticket-count">@Model.TicketDetails.Count(t => t.StatusText == "To Do" || t.StatusText == "Open")</span>
            </div>
            <div class="column-content">
                @foreach (var ticket in Model.TicketDetails.Where(t => t.StatusText == "To Do" || t.StatusText == "Open"))
                {
                    <div class="ticket-card" data-id="@ticket.TicketID" data-status-id="@ticket.StatusID">
                        <div class="ticket-header">
                            <h3 class="ticket-title">@ticket.Title</h3>
                            <span class="ticket-id">#@ticket.TicketID</span>
                        </div>
                        <div class="ticket-meta">
                            <div class="ticket-priority @ticket.PriorityText.ToLower()">
                                <span>@ticket.PriorityText</span>
                            </div>
                            <div class="ticket-category">
                                <span>@ticket.CategoryText</span>
                            </div>
                        </div>
                        <div class="ticket-assignee">
                            <div class="avatar">
                                @if (!string.IsNullOrEmpty(ticket.AssigneeName))
                                {
                                    @ticket.AssigneeName.Substring(0, 1)
                                }
                                else
                                {
                                    <i class="bi bi-person"></i>
                                }
                            </div>
                            <span>@(string.IsNullOrEmpty(ticket.AssigneeName) ? "Unassigned" : ticket.AssigneeName)</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="board-column">
            <div class="column-header">
                <h2>In Progress</h2>
                <span class="ticket-count">@Model.TicketDetails.Count(t => t.StatusText == "In Progress")</span>
            </div>
            <div class="column-content">
                @foreach (var ticket in Model.TicketDetails.Where(t => t.StatusText == "In Progress"))
                {
                    <div class="ticket-card" data-id="@ticket.TicketID" data-status-id="@ticket.StatusID">
                        <div class="ticket-header">
                            <h3 class="ticket-title">@ticket.Title</h3>
                            <span class="ticket-id">#@ticket.TicketID</span>
                        </div>
                        <div class="ticket-meta">
                            <div class="ticket-priority @ticket.PriorityText.ToLower()">
                                <span>@ticket.PriorityText</span>
                            </div>
                            <div class="ticket-category">
                                <span>@ticket.CategoryText</span>
                            </div>
                        </div>
                        <div class="ticket-assignee">
                            <div class="avatar">
                                @if (!string.IsNullOrEmpty(ticket.AssigneeName))
                                {
                                    @ticket.AssigneeName.Substring(0, 1)
                                }
                                else
                                {
                                    <i class="bi bi-person"></i>
                                }
                            </div>
                            <span>@(string.IsNullOrEmpty(ticket.AssigneeName) ? "Unassigned" : ticket.AssigneeName)</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Testing Column -->
        <div class="board-column">
            <div class="column-header">
                <h2>Testing</h2>
                <span class="ticket-count">@Model.TicketDetails.Count(t => t.StatusText == "Testing")</span>
            </div>
            <div class="column-content">
                @foreach (var ticket in Model.TicketDetails.Where(t => t.StatusText == "Testing"))
                {
                    <div class="ticket-card" data-id="@ticket.TicketID" data-status-id="@ticket.StatusID">
                        <div class="ticket-header">
                            <h3 class="ticket-title">@ticket.Title</h3>
                            <span class="ticket-id">#@ticket.TicketID</span>
                        </div>
                        <div class="ticket-meta">
                            <div class="ticket-priority @ticket.PriorityText.ToLower()">
                                <span>@ticket.PriorityText</span>
                            </div>
                            <div class="ticket-category">
                                <span>@ticket.CategoryText</span>
                            </div>
                        </div>
                        <div class="ticket-assignee">
                            <div class="avatar">
                                @if (!string.IsNullOrEmpty(ticket.AssigneeName))
                                {
                                    @ticket.AssigneeName.Substring(0, 1)
                                }
                                else
                                {
                                    <i class="bi bi-person"></i>
                                }
                            </div>
                            <span>@(string.IsNullOrEmpty(ticket.AssigneeName) ? "Unassigned" : ticket.AssigneeName)</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Done Column -->
        <div class="board-column">
            <div class="column-header">
                <h2>Done</h2>
                <span class="ticket-count">@Model.TicketDetails.Count(t => t.StatusText == "Closed" || t.StatusText == "Done")</span>
            </div>
            <div class="column-content">
                @foreach (var ticket in Model.TicketDetails.Where(t => t.StatusText == "Closed" || t.StatusText == "Done"))
                {
                    <div class="ticket-card" data-id="@ticket.TicketID" data-status-id="@ticket.StatusID">
                        <div class="ticket-header">
                            <h3 class="ticket-title">@ticket.Title</h3>
                            <span class="ticket-id">#@ticket.TicketID</span>
                        </div>
                        <div class="ticket-meta">
                            <div class="ticket-priority @ticket.PriorityText.ToLower()">
                                <span>@ticket.PriorityText</span>
                            </div>
                            <div class="ticket-category">
                                <span>@ticket.CategoryText</span>
                            </div>
                        </div>
                        <div class="ticket-assignee">
                            <div class="avatar">
                                @if (!string.IsNullOrEmpty(ticket.AssigneeName))
                                {
                                    @ticket.AssigneeName.Substring(0, 1)
                                }
                                else
                                {
                                    <i class="bi bi-person"></i>
                                }
                            </div>
                            <span>@(string.IsNullOrEmpty(ticket.AssigneeName) ? "Unassigned" : ticket.AssigneeName)</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <a href="@Url.Action("Create", "Ticket")" class="btn-create-ticket">
        <i class="bi bi-plus"></i>
    </a>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script>
        $(document).ready(function() {
            // Search function
            function performSearch() {
                const searchTerm = $("#search-input").val().toLowerCase();
                
                if (searchTerm === '') {
                    $(".ticket-card").show();
                    return;
                }
                
                $(".ticket-card").each(function() {
                    const title = $(this).find(".ticket-title").text().toLowerCase();
                    
                    if (title.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }
            
            // Search button click
            $("#search-button").click(function() {
                performSearch();
            });
            
            // Search on Enter key press
            $("#search-input").keypress(function(e) {
                if (e.which === 13) { // Enter key code
                    e.preventDefault();
                    performSearch();
                }
            });
            
            // Apply filter based on selected status
            function applyStatusFilter() {
                const selectedStatus = $("#filter-status").val();
                
                if (selectedStatus === 'all') {
                    // Show all columns and tickets
                    $(".board-column").show();
                    $(".ticket-card").show();
                } else {
                    // Show all columns first
                    $(".board-column").show();
                    
                    // Hide tickets that don't match the selected status
                    $(".ticket-card").each(function() {
                        const ticketStatusId = $(this).data("status-id");
                        
                        if (ticketStatusId == selectedStatus) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
                }
                
                // Always update counters after applying filter
                updateCounters();
            }
            
            // Status filter change event
            $("#filter-status").change(function() {
                applyStatusFilter();
            });
            
            // Make ticket cards clickable
            $(".ticket-card").click(function() {
                const ticketId = $(this).data("id");
                window.location.href = '@Url.Action("Details", "Ticket")/' + ticketId;
            });
            
            // Initialize drag and drop for each column
            const columns = document.querySelectorAll('.column-content');
            
            columns.forEach((column, index) => {
                new Sortable(column, {
                    group: 'tickets',
                    animation: 150,
                    ghostClass: 'ticket-card-ghost',
                    chosenClass: 'ticket-card-chosen',
                    dragClass: 'ticket-card-drag',
                    onEnd: function(evt) {
                        const ticketId = evt.item.getAttribute('data-id');
                        const newStatus = getStatusFromColumnIndex(evt.to.parentElement.querySelector('.column-header h2').textContent.trim());
                        
                        if (ticketId && newStatus) {
                            updateTicketStatus(ticketId, newStatus);
                            
                            // Update the status-id data attribute on the ticket card
                            $(evt.item).attr('data-status-id', newStatus);
                            
                            // Reapply the current filter after status update
                            applyStatusFilter();
                        }
                    }
                });
            });
            
            // Get status ID from column name
            function getStatusFromColumnIndex(columnName) {
                switch(columnName) {
                    case 'To Do':
                        return 1004; // ID for "To Do" status
                    case 'In Progress':
                        return 1005; // ID for "In Progress" status
                    case 'Testing':
                        return 1008; // ID for "Testing" status
                    case 'Done':
                        return 1006; // ID for "Done/Closed" status
                    default:
                        return null;
                }
            }
            
            // Update ticket status via AJAX
            function updateTicketStatus(ticketId, statusId) {
                // Prevent navigation when dragging
                $('.ticket-card').off('click').on('click', function(e) {
                    const ticketId = $(this).data("id");
                    window.location.href = '@Url.Action("Details", "Ticket")/' + ticketId;
                });
                
                $.ajax({
                    url: '@Url.Action("UpdateStatus", "Ticket")',
                    type: 'POST',
                    data: {
                        ticketId: ticketId,
                        statusId: statusId
                    },
                    success: function(response) {
                        if (response.success) {
                            // Update was successful
                            updateCounters();
                        } else {
                            // Handle error
                            alert('Error updating ticket status: ' + response.message);
                            // Refresh the page to reset the board
                            location.reload();
                        }
                    },
                    error: function() {
                        alert('Error updating ticket status. Please try again.');
                        // Refresh the page to reset the board
                        location.reload();
                    }
                });
            }
            
            // Update the counters after drag and drop
            function updateCounters() {
                // Count all tickets in each column (not just visible ones)
                const todoCount = $('.board-column:nth-child(1) .column-content .ticket-card').length;
                const inProgressCount = $('.board-column:nth-child(2) .column-content .ticket-card').length;
                const testingCount = $('.board-column:nth-child(3) .column-content .ticket-card').length;
                const doneCount = $('.board-column:nth-child(4) .column-content .ticket-card').length;
                
                // Update status cards with total counts (regardless of filter)
                $('.status-card.todo .status-count').text(todoCount);
                $('.status-card.in-progress .status-count').text(inProgressCount);
                $('.status-card.testing .status-count').text(testingCount);
                $('.status-card.done .status-count').text(doneCount);
                
                // Update column headers with total counts (regardless of filter)
                $('.board-column:nth-child(1) .ticket-count').text(todoCount);
                $('.board-column:nth-child(2) .ticket-count').text(inProgressCount);
                $('.board-column:nth-child(3) .ticket-count').text(testingCount);
                $('.board-column:nth-child(4) .ticket-count').text(doneCount);
            }
            
            // Initial counter update on page load
            updateCounters();
        });
    </script>
}
